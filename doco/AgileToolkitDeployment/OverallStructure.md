You can read about my idea for having registration servers which (currently) are not implemented [here](https://github.com/agile-deployer/agile-infrastructure-build-client-scripts/blob/master/doco/AgileToolkitDeployment/RegistrationServer.md).

The overriding ethos of this toolkit is in regards to agile deployment meaning that it is completely decoupled from any particular provider. 
So, one of the features that I have made use of in development is the "Zero Trust" feature that is built in to Cloudflare which enables access codes to be required before access to a webproperty.

The problem here is that it ties the deployment to Cloudflare because the other DNS services don't facilitate this feature. 
With that in mind, therefore, I have developed the following structure that I wish to use for my deployment architecture which can be done in a provider independent way.

The aim of this toolkit is not global domination it is about providing local social networking and other type applications. With this in mind here is how I propose to make it as secure as possible for the users of the applications.

1. Preselect who (from your local community can be a user) through an offline process.
2. Run your own mailserver as described [here](https://github.com/agile-deployer/agile-infrastructure-build-client-scripts/blob/master/doco/AgileToolkitDeployment/RollYourOwnMailserver.md) such that you can issue people with domain specific emails such as fred@testsocial.org or eric@testsocial.org where test social is the main domain of your website. 
3. Set up a registration server (registration.testsocial.org) where users register (and later update if necessary) their username, email address (which you have given them) as well as the ip address of the machine that they wish to connect from (it may be possible to grab their ip address transparently behind the scenes). The registration server should be set up to only accept registrations from email domain addresses that you have issued.
4. Once a new user is registered write it to an S3 bucket automatically which stores all usernames email addresses and ip addresses that are generated by part of the registration process.
5. In your main application server update your firewalls as necessary to allow through connections from the ipaddress that the new user has registered and manually add the user to the database.
6. As you create the new user, email them a new password (that you created the account with) to their supplied email address (fred@testsocial.org) and set your application to require they enter a new password upon first login as well as 2FA.
7. The user should then be able to log in to your main application (www.testsocial.org) whilst the main application is totally firewalled off to all except authorised ip addresses.
8. During ordinary usage if the user changes IP address then they will have to revisit the registration server and either update the ip address that is associated to their email address or have the registration automatically detect their new ip address and in both cases, reconfigure the firwall as needed.

This is the best approach I can think of to maximally firewall off the main application so that its very hard for bad actors to access it without an acceptable IP address.  

With this approach its much more difficult to compromise the security of the application and if you examine my code, you can see that I use the native firewall as well as UFW so the native firewall of your provider should have robust DDOS defence mechanisms and if "they" get through that, there is still the UFW firewalls on your actual servers. With such a configuration it is one way of being able to run your own servers without such a high chance of them being "knocked offline". 
